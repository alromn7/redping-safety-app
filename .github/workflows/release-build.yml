name: Release Build & Verify

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    timeout-minutes: 30
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
      PLAY_PUBLISH: ${{ secrets.PLAY_PUBLISH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Decode Play service account (if provided)
        if: env.PLAY_SERVICE_ACCOUNT_JSON_BASE64 != ''
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path android\play | Out-Null
          [IO.File]::WriteAllBytes('android/play/service-account.json',[Convert]::FromBase64String($Env:PLAY_SERVICE_ACCOUNT_JSON_BASE64))
          Write-Host 'Play service account JSON decoded.'

      - name: Cache pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            **/build
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Decode release keystore
        shell: pwsh
        run: |
          if (-not $Env:ANDROID_KEYSTORE_BASE64) { Write-Host 'No keystore secret provided; using debug signing.'; exit 0 }
          New-Item -ItemType Directory -Force -Path android\keystore | Out-Null
          [IO.File]::WriteAllBytes('android\keystore\redping-release.jks',[Convert]::FromBase64String($Env:ANDROID_KEYSTORE_BASE64))
          Write-Host 'Release keystore decoded.'

      - name: Generate key.properties (if signing provided)
        shell: pwsh
        run: |
          if (-not $Env:ANDROID_KEYSTORE_PASSWORD -or -not $Env:ANDROID_KEY_PASSWORD -or -not $Env:ANDROID_KEY_ALIAS) {
            Write-Host 'Signing secrets incomplete; skipping key.properties.'; exit 0 }
          $lines = @(
            "storePassword=$Env:ANDROID_KEYSTORE_PASSWORD",
            "keyPassword=$Env:ANDROID_KEY_PASSWORD",
            "keyAlias=$Env:ANDROID_KEY_ALIAS",
            "storeFile=keystore/redping-release.jks"
          )
          $lines | Set-Content -Path android\key.properties -Encoding UTF8
          Write-Host 'key.properties generated.'

      - name: Export signing env vars
        shell: pwsh
        run: |
          $storeFile = "$PWD/android/keystore/redping-release.jks"
          if (-not (Test-Path $storeFile)) { Write-Host 'Keystore not found; will fall back to debug signing.' }
          echo "STORE_FILE=$storeFile" >> $Env:GITHUB_ENV
          if ($Env:ANDROID_KEYSTORE_PASSWORD) { echo "STORE_PASSWORD=$Env:ANDROID_KEYSTORE_PASSWORD" >> $Env:GITHUB_ENV }
          if ($Env:ANDROID_KEY_ALIAS) { echo "KEY_ALIAS=$Env:ANDROID_KEY_ALIAS" >> $Env:GITHUB_ENV }
          if ($Env:ANDROID_KEY_PASSWORD) { echo "KEY_PASSWORD=$Env:ANDROID_KEY_PASSWORD" >> $Env:GITHUB_ENV }
          Write-Host 'Signing environment variables exported.'

      - name: Validate keystore & alias
        shell: pwsh
        run: |
          if (-not $Env:STORE_FILE -or -not (Test-Path $Env:STORE_FILE)) { Write-Host 'No release keystore to validate.'; exit 0 }
          if (-not $Env:STORE_PASSWORD -or -not $Env:KEY_ALIAS) { Write-Host 'Missing STORE_PASSWORD or KEY_ALIAS; cannot validate keystore.'; exit 0 }
          & "$Env:JAVA_HOME\bin\keytool" -list -keystore $Env:STORE_FILE -storepass $Env:STORE_PASSWORD -alias $Env:KEY_ALIAS 2>$null | Out-Null
          if ($LASTEXITCODE -ne 0) { Write-Error 'Keystore validation failed (bad password or alias).'; exit 1 } else { Write-Host 'Keystore validation passed.' }

      - name: Install dependencies
        run: flutter pub get
        shell: powershell

      - name: Run release build & verification script
        run: powershell -ExecutionPolicy Bypass -File .\release_build_verify.ps1 -SkipClean

      - name: Upload AAB artifact
        if: success() && hashFiles('build/app/outputs/bundle/release/app-release.aab') != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Upload APK artifact
        if: success() && hashFiles('build/app/outputs/flutter-apk/app-release.apk') != ''
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Print fingerprints summary
        shell: pwsh
        run: |
          if (-not $Env:STORE_FILE -or -not (Test-Path $Env:STORE_FILE)) { Write-Host 'No release keystore; skipping fingerprint.'; exit 0 }
          if (-not $Env:STORE_PASSWORD -or -not $Env:KEY_ALIAS) { Write-Host 'Missing alias/password; skipping fingerprint.'; exit 0 }
          & "$Env:JAVA_HOME\bin\keytool" -list -v -keystore $Env:STORE_FILE -storepass $Env:STORE_PASSWORD -alias $Env:KEY_ALIAS 2>$null | findstr /R "SHA1: SHA-256:" || exit 0

      - name: Verify artifact signatures
        shell: pwsh
        run: |
          $apkPath = "build/app/outputs/flutter-apk/app-release.apk"
          $aabPath = "build/app/outputs/bundle/release/app-release.aab"
          # Find latest build-tools containing apksigner
          $btRoot = $Env:ANDROID_HOME
          if (-not $btRoot) { Write-Host 'ANDROID_HOME not set; skipping signature verification.'; exit 0 }
          $apksigner = Get-ChildItem "$btRoot/build-tools" -Filter apksigner* -Recurse -ErrorAction SilentlyContinue | Sort-Object FullName -Descending | Select-Object -First 1
          if (-not $apksigner) { Write-Host 'apksigner not found; skipping APK verification.' }
          # Verify APK
          if (Test-Path $apkPath -and $apksigner) {
            & $apksigner.FullName verify --verbose --print-certs $apkPath | Tee-Object -Variable apkVerify
            if ($LASTEXITCODE -ne 0) { Write-Error 'APK signature verification failed.'; exit 1 }
            if ($apkVerify -match 'androiddebugkey') { Write-Error 'APK signed with debug key (androiddebugkey). Failing.'; exit 1 }
            Write-Host 'APK signature verification passed.'
          } else { Write-Host 'No release APK found or apksigner missing; skipped.' }
          # Verify AAB using jarsigner
          if (Test-Path $aabPath) {
            & "$Env:JAVA_HOME\bin\jarsigner" -verify -verbose -certs $aabPath | Tee-Object -Variable aabVerify
            if ($LASTEXITCODE -ne 0) { Write-Error 'AAB jarsigner verification failed.'; exit 1 }
            if ($aabVerify -match 'androiddebugkey') { Write-Error 'AAB signed with debug key. Failing.'; exit 1 }
            Write-Host 'AAB signature verification passed.'
          } else { Write-Host 'No release AAB found; skipped.' }
          Write-Host 'Signature verification completed.'

      - name: Generate SHA-256 checksums
        shell: pwsh
        run: |
          $files = @(
            'build/app/outputs/flutter-apk/app-release.apk',
            'build/app/outputs/bundle/release/app-release.aab'
          )
          foreach ($f in $files) {
            if (Test-Path $f) {
              $hash = (Get-FileHash -Algorithm SHA256 -Path $f).Hash
              Write-Host "SHA256 $f => $hash"
              Add-Content -Path checksums.txt "${f}: ${hash}" -Encoding UTF8
            }
          }
          if (Test-Path checksums.txt) { Write-Host 'Checksum file created.' } else { Write-Host 'No artifacts present for hashing.' }

      - name: Upload mapping file
        if: success() && hashFiles('build/app/outputs/mapping/release/mapping.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: proguard-mapping
          path: build/app/outputs/mapping/release/mapping.txt

      - name: Upload checksum log
        if: success() && hashFiles('checksums.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: release-checksums
          path: checksums.txt

  device-smoke:
    if: ${{ success() }}
    needs: build-release
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      STARTUP_THRESHOLD_MS: ${{ secrets.STARTUP_THRESHOLD_MS }}
      MAX_PSS_KB: ${{ secrets.MAX_PSS_KB }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-apk
          path: artifacts

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Start emulator & run smoke
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          script: |
            adb install artifacts/app-release.apk
            adb shell monkey -p com.redping.redping -c android.intent.category.LAUNCHER 1
            sleep 5
            adb logcat -d | grep com.redping.redping | head -n 200 > smoke_log.txt
            test -s smoke_log.txt || echo 'No relevant log lines captured.' > smoke_log.txt

      - name: Upload smoke logs
        uses: actions/upload-artifact@v4
        with:
          name: device-smoke-logs
          path: smoke_log.txt

      - name: Evaluate startup performance threshold
        if: success()
        shell: bash
        run: |
          set -e
          threshold=${STARTUP_THRESHOLD_MS:-0}
          echo "Configured threshold: ${threshold}ms"
          if [ "$threshold" -gt 0 ]; then
            line=$(grep -E 'Displayed com\.redping\.redping' smoke_log.txt || true)
            if [ -n "$line" ]; then
              echo "Startup line: $line"
              ms=$(echo "$line" | sed -E 's/.*Displayed .* \(([0-9]+)ms\).*/\1/')
              echo "Parsed startup time: ${ms}ms"
              if [ -n "$ms" ] && [ "$ms" -gt "$threshold" ]; then
                echo "Startup time ${ms}ms exceeded threshold ${threshold}ms" >&2
                exit 1
              else
                echo "Startup time within threshold.";
              fi
            else
              echo "No startup timing line found; skipping enforcement."
            fi
          else
            echo "No threshold configured (STARTUP_THRESHOLD_MS not set)."
          fi

      - name: Extract perf metrics
        if: always()
        shell: bash
        run: |
          line=$(grep -E 'Displayed com\.redping\.redping' smoke_log.txt || true)
          if [ -n "$line" ]; then
            ms=$(echo "$line" | sed -E 's/.*Displayed .* \(([0-9]+)ms\).*/\1/')
            echo "startup_ms=${ms}" > perf_metrics.txt
          else
            echo "startup_ms=unknown" > perf_metrics.txt
          fi
          echo "Collecting memory info" >> perf_metrics.txt
          adb shell dumpsys meminfo com.redping.redping > meminfo.txt || true
          pss=$(grep -E 'TOTAL' meminfo.txt | awk '{print $2}' | head -n1)
          if [ -n "$pss" ]; then echo "total_pss_kb=${pss}" >> perf_metrics.txt; else echo "total_pss_kb=unknown" >> perf_metrics.txt; fi
          cpuLine=$(adb shell dumpsys cpuinfo | grep -E 'com.redping.redping' | head -n1 || true)
          if [ -n "$cpuLine" ]; then echo "cpu_info=${cpuLine}" >> perf_metrics.txt; fi
          # Build a perf history JSON entry
          commit_sha=${GITHUB_SHA}
          tag_ref=${GITHUB_REF##*/}
          startup=$(grep -E '^startup_ms=' perf_metrics.txt | cut -d'=' -f2)
          pss_val=$(grep -E '^total_pss_kb=' perf_metrics.txt | cut -d'=' -f2)
          thresholds_json=$(jq -n --arg startup_thr "${STARTUP_THRESHOLD_MS}" --arg pss_thr "${MAX_PSS_KB}" '{startupThresholdMs: ($startup_thr|tonumber?), maxPssKb: ($pss_thr|tonumber?)}')
          jq -n --arg sha "$commit_sha" --arg tag "$tag_ref" --arg startup "$startup" --arg pss "$pss_val" --argjson thr "$thresholds_json" '{commitSha:$sha, tag:$tag, startupMs:($startup|tonumber?), totalPssKb:($pss|tonumber?), thresholds:$thr, timestamp: (now|strftime("%Y-%m-%dT%H:%M:%SZ"))}' > perf_history_entry.json || echo '{"error":"jq unavailable"}' > perf_history_entry.json

      - name: Enforce memory threshold
        if: success()
        shell: bash
        run: |
          max=${MAX_PSS_KB:-0}
          if [ "$max" -gt 0 ]; then
            pss=$(grep -E '^total_pss_kb=' perf_metrics.txt | cut -d'=' -f2)
            if [ -n "$pss" ] && [ "$pss" != "unknown" ]; then
              echo "PSS: ${pss} KB (limit ${max} KB)"
              if [ "$pss" -gt "$max" ]; then
                echo "Memory PSS ${pss}KB exceeded threshold ${max}KB" >&2
                exit 1
              fi
            else
              echo "No PSS parsed; skipping memory enforcement"
            fi
          else
            echo "No memory threshold configured (MAX_PSS_KB not set)."
          fi

      - name: Upload perf metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: startup-perf-metrics
          path: perf_metrics.txt

      - name: Upload perf history entry
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-history-entry
          path: perf_history_entry.json

      - name: Publish to Play (internal track)
        if: false
        shell: bash
        run: echo "Deprecated step moved to publish-play job."

  api-probe:
    if: ${{ needs.build-release.result == 'success' }}
    needs: build-release
    runs-on: windows-latest
    timeout-minutes: 5
    env:
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run API probe
        if: env.API_BASE_URL != ''
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\api_probe.ps1 -BaseUrl $Env:API_BASE_URL

      - name: Upload API probe results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-probe-results
          path: api_probe.json

  publish-play:
    if: ${{ needs.build-release.result == 'success' && needs.device-smoke.result == 'success' && needs.api-probe.result == 'success' }}
    needs: [build-release, device-smoke, api-probe]
    runs-on: windows-latest
    timeout-minutes: 15
    env:
      PLAY_PUBLISH: ${{ secrets.PLAY_PUBLISH }}
      PLAY_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode Play service account (if provided)
        if: env.PLAY_SERVICE_ACCOUNT_JSON_BASE64 != ''
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path android\play | Out-Null
          [IO.File]::WriteAllBytes('android/play/service-account.json',[Convert]::FromBase64String($Env:PLAY_SERVICE_ACCOUNT_JSON_BASE64))
          Write-Host 'Play service account JSON decoded.'

      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release-aab
          path: artifacts

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Publish to Play (internal track)
        if: env.PLAY_PUBLISH == 'true'
        shell: pwsh
        run: |
          Write-Host 'Publishing bundle to Google Play internal track (gated by previous job success).'
          cd android
          ./gradlew :app:publishReleaseBundle --stacktrace

  adaptive-thresholds:
    if: ${{ needs.device-smoke.result == 'success' }}
    needs: [device-smoke]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download perf history entry
        uses: actions/download-artifact@v4
        with:
          name: perf-history-entry
          path: perf_entry
      - name: Append perf history
        shell: bash
        run: |
          mkdir -p .ci
          entryFile=perf_entry/perf_history_entry.json
          if [ ! -f "$entryFile" ]; then echo 'No perf history entry artifact found'; exit 0; fi
          touch .ci/perf_history.jsonl
          cat "$entryFile" >> .ci/perf_history.jsonl
          echo >> .ci/perf_history.jsonl
          lines=$(wc -l < .ci/perf_history.jsonl)
          echo "History lines: $lines"
          tailCount=$(( lines < 15 ? lines : 15 ))
          startupVals=$(tail -n "$tailCount" .ci/perf_history.jsonl | jq -r 'select(.startupMs!=null) | .startupMs')
          memVals=$(tail -n "$tailCount" .ci/perf_history.jsonl | jq -r 'select(.totalPssKb!=null) | .totalPssKb')
          dynStartupThr=0
          dynMemThr=0
          if [ -n "$startupVals" ]; then
            avg=$(echo "$startupVals" | awk '{sum+=$1} END {if (NR>0) print sum/NR}')
            dynStartupThr=$(printf '%.0f' $(echo "$avg * 1.40" | bc -l))
          fi
          if [ -n "$memVals" ]; then
            avgm=$(echo "$memVals" | awk '{sum+=$1} END {if (NR>0) print sum/NR}')
            dynMemThr=$(printf '%.0f' $(echo "$avgm * 1.35" | bc -l))
          fi
          jq -n --arg startup "$dynStartupThr" --arg mem "$dynMemThr" '{dynamicStartupThresholdMs: ($startup|tonumber?), dynamicMaxPssKb: ($mem|tonumber?)}' > .ci/dynamic_thresholds.json
      - name: Commit updated history & thresholds
        shell: bash
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .ci/perf_history.jsonl .ci/dynamic_thresholds.json || true
          git commit -m "CI: update perf history & dynamic thresholds" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push skipped"
      - name: Upload dynamic thresholds
        uses: actions/upload-artifact@v4
        with:
          name: dynamic-thresholds
          path: .ci/dynamic_thresholds.json

  weekly-report:
    if: ${{ needs.adaptive-thresholds.result == 'success' && startsWith(github.ref, 'refs/tags/') }}
    needs: [adaptive-thresholds]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate weekly report (Monday only)
        shell: bash
        run: |
          dow=$(date +%u) # 1=Mon
          if [ "$dow" != "1" ]; then echo "Not Monday; skipping weekly report"; exit 0; fi
          if [ ! -f .ci/perf_history.jsonl ]; then echo "No history file"; exit 0; fi
          last7=$(tail -n 70 .ci/perf_history.jsonl | jq -s '[-7:]')
          avgStartup=$(echo "$last7" | jq '[ .[] | .startupMs // empty ] | if length>0 then (add/length) else 0 end')
          avgMem=$(echo "$last7" | jq '[ .[] | .totalPssKb // empty ] | if length>0 then (add/length) else 0 end')
          jq -n --argjson data "$last7" --arg avgS "$avgStartup" --arg avgM "$avgMem" '{weekEntries:$data, averages:{startupMs:($avgS|tonumber?), totalPssKb:($avgM|tonumber?)}, generated: (now|strftime("%Y-%m-%dT%H:%M:%SZ"))}' > .ci/perf_weekly_report.json
          printf "# Weekly Performance Report\nGenerated: $(date -u)\nAverage Startup (ms): $avgStartup\nAverage PSS (KB): $avgMem\n" > perf_weekly_report.md
          echo "(See .ci/perf_weekly_report.json for raw data)" >> perf_weekly_report.md
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .ci/perf_weekly_report.json perf_weekly_report.md || true
          git commit -m "CI: weekly performance report" || echo "No weekly changes"
          git push origin HEAD:main || echo "Push skipped"
      - name: Upload weekly report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-performance-report
          path: perf_weekly_report.md

  rollback-or-tag:
    if: always()
    needs: [build-release, device-smoke, api-probe, publish-play]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      ROLLBACK_ENABLED: ${{ secrets.ROLLBACK_ENABLED }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create failure tag if any failed
        shell: bash
        run: |
          statuses=('${{ needs.build-release.result }}' '${{ needs.device-smoke.result }}' '${{ needs.api-probe.result }}' '${{ needs.publish-play.result }}')
          fail=false
          for s in "${statuses[@]}"; do [ "$s" = "failure" ] && fail=true; done
          if [ "$fail" = true ]; then
            echo "Detected failure in pipeline"
            if [ "$ROLLBACK_ENABLED" = "true" ]; then
              git config user.name "github-actions"
              git config user.email "github-actions@users.noreply.github.com"
              prev=$(git rev-parse HEAD)
              tagName="failed-${GITHUB_RUN_NUMBER}"
              git tag "$tagName" "$prev"
              git push origin "$tagName" || echo "Tag push failed"
              echo "Failure tag created: $tagName"
            else
              echo "Rollback disabled; skipping tag creation"
            fi
          else
            echo "No failures; no rollback/tag needed"
  notify:
    if: always()
    needs: [build-release, device-smoke, api-probe, publish-play]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Compose notification summary
        shell: bash
        run: |
          build_status='${{ needs.build-release.result }}'
          smoke_status='${{ needs.device-smoke.result }}'
          probe_status='${{ needs.api-probe.result }}'
          publish_status='${{ needs.publish-play.result }}'
          summary="Build: $build_status, Smoke: $smoke_status, API: $probe_status, Publish: $publish_status"
          echo "$summary" > notify_summary.txt
          echo "Summary: $summary"
          if [ -f perf_history_entry.json ]; then cat perf_history_entry.json >> notify_summary.txt; fi
      - name: Send Slack notification (if webhook provided)
        if: env.SLACK_WEBHOOK_URL != ''
        shell: bash
        run: |
          text=$(sed ':a;N;$!ba;s/\n/ | /g' notify_summary.txt)
          payload=$(jq -n --arg t "$text" '{text:$t}')
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || echo 'Slack post failed'
      - name: Upload notification summary
        uses: actions/upload-artifact@v4
        with:
          name: notify-summary
          path: notify_summary.txt
